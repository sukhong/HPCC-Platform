<html>
<head>
  <title> Column-Level Security View Demo </title>
  <script src="jquery-3.0.0.js"></script>
  <script>
    var server = 'http://127.0.0.1:8010';
  </script>
  <style>
    body {
      margin: 0px;
    }
    .container {
      width: 100%;
      height: 500px;
    }
    .column {
      width: 33.33%;
      height: 100%;
      display: flex;
      float: left;
    }

    .flex_column_container {
      width: 100%;
      display: flex;
      flex-flow: column;
    }

    .flex_fill {
      width: 100%;
      flex: 1 1 auto;
    }

    .bottom_flex_button {
      width: 100%;
      height: 30px;
      flex: 0 1 auto;
    }

    .dialog {
      z-index: 2;
      position: absolute;
      margin: auto;
      width: 50%;
      height: 60%;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 2px solid grey;
      background-color: white
    }

    select option {
      height: 30px;
    }
  </style>
</head>
<body>
  <div id="loading_bar" style="display: none; z-index: 1; position: fixed; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);"></div>
  <div id="dialog_loading_bar" style="display: none; z-index: 3; position: fixed; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);"></div>
  <div style="position: relative;" class="container">
    <div id="add_view_dialog" class="dialog" style="display: none;">
      <div style="margin: 10px;">
        <div>View Name:</div>
        <input id="new_view_name" type="text" size="30"/>
        <div>View Description:</div>
        <input id="new_view_description" type="text" size="30"/>
        <div style="margin: 5px;">
          <button id="submit_add_view_button">Submit</button>
          <button id="cancel_add_view_button">Cancel</button>
        </div>
      </div>
    </div>

    <div id="add_column_dialog" class="dialog" style="display: none;">
      <div>
        <div class="column" style="width: 50%;">
          <div class="flex_column_container">
            <div style="border: 1px solid grey">Files: </div>
            <select class="flex_fill" size="5">
              <option>test::file</option>
              <option>test::morefile</option>
            </select>
          </div>
        </div>
        <div class="column" style="width: 50%;">
          <div class="flex_column_container">
            <div style="border: 1px solid grey">Columns: </div>
            <select class="flex_fill" size="5">
              <option>test::file</option>
              <option>test::morefile</option>
            </select>
            <button id="submit_add_column_button" class="bottom_flex_button">Submit</button>
            <button id="cancel_add_column_button" class="bottom_flex_button">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <div id="add_member_dialog" class="dialog" style="display: none;">
      <div>
        <div class="column" style="width: 100%;">
          <div class="flex_column_container">
            <div style="border: 1px solid grey">Add User: </div>
            <select id="add_member_list" class="flex_fill" size="5">
            </select>
            <button id="submit_add_user_button" class="bottom_flex_button">Add User</button>
            <button id="cancel_add_member_button" class="bottom_flex_button">Cancel</button>
          </div>
        </div>
        <!--
        <div class="column" style="width: 50%;">
          <div class="flex_column_container">
            <div style="border: 1px solid grey">Add Group: </div>
            <select class="flex_fill" size="5">
              <option>Managers</option>
              <option>2016 Summer Interns</option>
            </select>
            <button id="submit_add_group_button" class="bottom_flex_button">Add Group</button>
          </div>
        </div>-->
      </div>
    </div>

    <div class="column">
      <div class="flex_column_container">
        <div style="margin: 3px;">Views</div>
        <select id="view_list" class="flex_fill" size="5">
        </select>
        <button id="add_view_button" type="button" class="bottom_flex_button">Add View</button>
        <button id="delete_view_button" type="button" class="bottom_flex_button">Delete View</button>
      </div>
    </div>
    <div class="column">
      <div class="flex_column_container">
        <div style="margin: 3px;">Columns</div>
        <select id="column_list" class="flex_fill" size="5">
        </select>
        <button id="add_column_button" type="button" class="bottom_flex_button" disabled>Add Column</button>
        <button id="delete_column_button" type="button" class="bottom_flex_button" disabled>Delete Column</button>
      </div>
    </div>
    <div class="column">
      <div class="flex_column_container">
        <div style="margin: 3px;">Members</div>
        <select id="member_list" class="flex_fill" size="5">
        </select>
        <button id="add_member_button" type="button" class="bottom_flex_button" disabled>Add Member</button>
        <button id="delete_member_button" type="button" class="bottom_flex_button" disabled>Delete Member</button>
      </div>
    </div>
    <button id="clear_selection_button" type="button" style="float: right; width: 20%; height: 30px; margin: 10px;">Clear Selection</button>
  </div>
  <script>
  /* Basic functions */
  function showLoadingBar() {
    $('#loading_bar').show();
  }

  function hideLoadingBar() {
    $('#loading_bar').hide();
  }

  function showDialogLoadingBar() {
    $('#dialog_loading_bar').show();
  }

  function hideDialogLoadingBar() {
    $('#dialog_loading_bar').hide();
  }

  function showDialog(name) {
    $(name).show();
    showLoadingBar();
  }

  function hideDialog(name) {
    $(name).hide();
    hideLoadingBar();
    hideDialogLoadingBar();
  }

  function alertOnFailure(data) {
    if ($(data).find('success').text() == 0)
    {
      alert($(data).find('result').text());
      return true;
    }
    return false;
  }

  function disableButtons() {
    $("#delete_view_button").prop("disabled", true);
    $("#add_column_button").prop("disabled", true);
    $("#delete_column_button").prop("disabled", true);
    $("#add_member_button").prop("disabled", true);
    $("#delete_member_button").prop("disabled", true);
  }

  function enableButtons() {
    $("#delete_view_button").prop("disabled", false);
    $("#add_column_button").prop("disabled", false);
    $("#delete_column_button").prop("disabled", false);
    $("#add_member_button").prop("disabled", false);
    $("#delete_member_button").prop("disabled", false);
  }

  function resetScreen() {
    $("#column_list").val([]);
    $("#member_list").val([]);
    $("#add_member_list").val([]);

    $("#column_list").empty();
    $("#member_list").empty();
    $("#add_member_list").empty();

    disableButtons();
    refreshViewList();
  }
  </script>
  <script>
    $('#add_view_button').click(function(){
      showDialog('#add_view_dialog');
    });

    $('#delete_view_button').click(function(){
      var viewList = $('#view_list');

      if (viewList.val() == null)
      {
        alert('Please select a view first');
        return;
      }

      var selected_view_name = viewList.find(':selected').attr('data-name');
      var data = encodeURI('viewname=' + selected_view_name);

      showLoadingBar();

      $.ajax({
        url: server + "/ws_access/deleteView",
        method: "POST",
        data: data,
        async: false
      }).done(function(data) {
        alertOnFailure(data);
        hideLoadingBar();
        resetScreen();
      }).fail(function(jqXHR, textStatus, errorThrown)
      {
        hideLoadingBar();
        alert(textStatus);
      });
    });

    $('#submit_add_view_button').click(function(){
      var new_view_name = $('#new_view_name').val();
      var new_view_description = $('#new_view_description').val();

      if (new_view_name == '')
      {
        alert('view name is required');
        return;
      }

      var data = encodeURI('viewname=' + new_view_name + '&description=' + new_view_description);

      showDialogLoadingBar();

      $.ajax({
        url: server + "/ws_access/addView",
        method: "POST",
        data: data,
        async: false
      }).done(function(data) {

        alertOnFailure(data);

        hideDialogLoadingBar();
        hideDialog('#add_view_dialog');
        refreshViewList();
      }).fail(function(jqXHR, textStatus, errorThrown)
      {
        hideDialogLoadingBar();
        alert(textStatus);
      });

      $('#new_view_name').val('');
      $('#new_view_description').val('');
    });

    $('#cancel_add_view_button').click(function(){
      hideDialog('#add_view_dialog');
    });

    $('#view_list').change(function() {
      var $clickedItem = $(this).children(':selected');
      var clicked_view_name = $clickedItem.attr('data-name');

      var column_list = $('#column_list');
      column_list.empty();

      var member_list = $('#member_list');
      member_list.empty();

      var data = encodeURI('viewname=' + clicked_view_name);

      // When a view is clicked, we need to load columns and members for a view
      showLoadingBar();

      $.ajax({
        url: server + "/ws_access/queryViewColumns",
        data: data,
        async: false
      }).done(function(data) {
        alertOnFailure(data);

        var viewArray = $(data).find('ViewColumn');

        $.each(viewArray, function(index, view)
        {
          $view = $(view);
          var file_name = $view.find('filename').text();
          var column_name = $view.find('columnname').text();
          var optionItem = $('<option/>').attr('data-file', file_name).attr('data-column', column_name).text(file_name + "::" + column_name);
          column_list.append(optionItem);
        });
      }).fail(function(jqXHR, textStatus, errorThrown)
      {
        alert(textStatus);
      });

      $.ajax({
        url: server + "/ws_access/queryViewMembers",
        data: data,
        async: false
      }).done(function(data) {
        alertOnFailure(data);

        hideLoadingBar();

        var viewArray = $(data).find('ViewMember');

        $.each(viewArray, function(index, view)
        {
          $view = $(view);
          var member_name = $view.find('name').text();
          var member_type = $view.find('membertype').text();
          var optionItem = $('<option/>').attr('data-name', member_name).attr('data-type', member_type).text(member_name + " (" + member_type + ")");
          member_list.append(optionItem);
        });
      }).fail(function(jqXHR, textStatus, errorThrown)
      {
        hideLoadingBar();
        alert(textStatus);
      });

      enableButtons();
    });

    $('#add_column_button').click(function(){
      showDialog('#add_column_dialog');
    });

    $('#delete_column_button').click(function(){
      alert('delete column button clicked');
    });

    $('#submit_add_column_button').click(function(){
      hideDialog('#add_column_dialog');
    });

    $('#cancel_add_column_button').click(function(){
      hideDialog('#add_column_dialog');
    });

    $('#add_member_button').click(function(){
      showDialog('#add_member_dialog');

      showDialogLoadingBar();

      var add_member_list = $('#add_member_list');
      add_member_list.empty();

      $.ajax({
        url: server + "/ws_access/Users",
        async: false
      }).done(function(data) {
        hideDialogLoadingBar();
        var array = $(data).find('User');

        $.each(array, function(index, item)
        {
          $item = $(item);
          var username = $item.find('username').text();
          var fullname = $item.find('fullname').text();
          var optionItem = $('<option/>').attr('data-username', username).text(username + ' (' + fullname + ')');
          add_member_list.append(optionItem);
        });
      }).fail(function(jqXHR, textStatus, errorThrown)
      {
        hideDialogLoadingBar();
        alert(textStatus);
      });
    });

    $('#delete_member_button').click(function(){
      var viewList = $('#view_list');
      var memberList = $('#member_list');

      if (memberList.val() == null)
      {
        alert('Please select a member first');
        return;
      }

      var selected_view_name = viewList.find(':selected').attr('data-name');
      var selected_member_name = memberList.find(':selected').attr('data-name');
      var data = encodeURI('viewname=' + selected_view_name + '&membername=' + selected_member_name + '&membertype=' + 'User');

      showLoadingBar();

      $.ajax({
        url: server + "/ws_access/deleteViewMember",
        method: "POST",
        data: data,
        async: false
      }).done(function(data) {
        alertOnFailure(data);
        hideLoadingBar();
        refreshMemberList();
      }).fail(function(jqXHR, textStatus, errorThrown)
      {
        hideLoadingBar();
        alert(textStatus);
      });
    });

    $('#submit_add_user_button').click(function(){
      var addMemberList = $('#add_member_list');

      if (addMemberList.val() == null)
      {
        alert('Please select a user to add first');
        return;
      }

      var selected_view_name = $('#view_list').find(':selected').attr('data-name');
      var selected_user_name = addMemberList.find(':selected').attr('data-username');
      var data = encodeURI('viewname=' + selected_view_name + '&membername=' + selected_user_name + '&membertype=' + 'User');

      showDialogLoadingBar();

      $.ajax({
        url: server + "/ws_access/addViewMember",
        method: "POST",
        data: data,
        async: false
      }).done(function(data) {
        alertOnFailure(data);
        hideDialogLoadingBar();
      }).fail(function(jqXHR, textStatus, errorThrown)
      {
        hideDialogLoadingBar();
        alert(textStatus);
      });

      hideDialog('#add_member_dialog');
      refreshMemberList();
    });

    $('#submit_add_group_button').click(function(){
      hideDialog('#add_member_dialog');
    });

    $('#cancel_add_member_button').click(function(){
      hideDialog('#add_member_dialog');
    });

    $('#clear_selection_button').click(function(){
      resetScreen();
    });
  </script>
  <script>

  function refreshViewList()
  {
    var viewList = $('#view_list');
    viewList.empty();
    showLoadingBar();

    $.ajax({
      url: server + "/ws_access/queryViews",
      async: false
    }).done(function(data) {
      hideLoadingBar();
      var viewArray = $(data).find('View');

      $.each(viewArray, function(index, view)
      {
        $view = $(view);
        var viewname = $view.find('viewname').text();
        var viewdesc = $view.find('description').text();
        var optionItem = $('<option/>').attr('data-name', viewname).attr('data-desc', viewdesc).text(viewname + ': ' + viewdesc);
        viewList.append(optionItem);
      });
    }).fail(function(jqXHR, textStatus, errorThrown)
    {
      hideLoadingBar();
      alert(textStatus);
    });

    $('#column_list').empty();
    $('#member_list').empty();
  }

  function refreshMemberList()
  {
    var member_list = $('#member_list');
    member_list.empty();
    showLoadingBar();

    var selected_view_name = $('#view_list').find(':selected').attr('data-name');

    var data = encodeURI('viewname=' + selected_view_name);

    $.ajax({
      url: server + "/ws_access/queryViewMembers",
      data: data,
      async: false
    }).done(function(data) {
      alertOnFailure(data);

      hideLoadingBar();

      var viewArray = $(data).find('ViewMember');

      $.each(viewArray, function(index, view)
      {
        $view = $(view);
        var member_name = $view.find('name').text();
        var member_type = $view.find('membertype').text();
        var optionItem = $('<option/>').attr('data-name', member_name).attr('data-type', member_type).text(member_name + " (" + member_type + ")");
        member_list.append(optionItem);
      });
    }).fail(function(jqXHR, textStatus, errorThrown)
    {
      hideLoadingBar();
      alert(textStatus);
    });
  }

  resetScreen();
  </script>
</body>
</html>
